<% @user = current_user %>
<% friends = @user.friends %>
<% array = [] %>

<% friends.each do |friend| %>

  <% if friend.friends.where(city: @request.city).count > 1 || friend.city == @request.city %>
    <% array << friend %>
  <% end %>
<% end %>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-12 col-md-8">
      <h1>Ask friends for help</h1>
      <div hidden>
        <% if friends.empty? %>
          <br>
          <p>You don't have any friends yet. <%= link_to "Find friends now", root_path %></p>
          <br>
        <% else %>
          <%= simple_form_for [ @request, @private_share ] do |f| %>
            <% if array.empty?  %>
              <%= f.input :user do %>
                <%= f.select :user_id, friends.map{ |l| ["#{l.first_name} #{l.last_name} (lives in #{l.city}, has #{l.friends.where(city: @request.city).count} friends in #{@request.city})", l.id, {:first_name => l.first_name}] }, { :prompt => false},
                { :multiple => true } %>
              <% end %> 
            <% else %>
              <br>
              <%= f.label "Choose friends who live in #{@request.city} or have friends there:" %>
              <%= f.input :user , label: false do %>
                <%= f.select :user_id, array.sort_by { |hsh| hsh[:city] }.map{ |l| ["#{l.first_name} #{l.last_name} (lives in #{l.city}, has #{l.friends.where(city: @request.city).count} friends in #{@request.city})", l.id, {:first_name => l.first_name}] }, { :prompt => false},
                { :multiple => true, class: "select-checkbox" } %>
              <% end %>
            <% end %> 
      </div>
      <div class="scroll-friends">
        <% array.each do |friend| %>
          <div class="card-friend sharing">
            <% if friend.photo %>
              <%= image_tag friend.photo %>
            <% end %>
          <div class="card-friend-infos">
            <p class="user_id" hidden><%= friend.id %></p>
            <h2><%= friend.first_name %> <%= friend.last_name %></h2>
            <p>Lives in <strong><%= friend.city %></strong></p>
            <p>Has <%= friend.friends.where(city: @request.city).count %> friends in <%= @request.city %></p>
          </div>
          <h2><i class="check-friend fas fa-check-circle "></i></h2>
      </div>
      <br>
  
        <% end %>
    </div>
          <% if @request.user == current_user %> <%# Only request-maker can set privacy level  %>
            <div class="custom-control custom-switch">
              <%= f.input_field :privacy_level, class: "custom-control-input", id: "customSwitch1"   %>
              <label class="custom-control-label" for="customSwitch1"> Allow friends to reshare request </label>
            </div>
          <% end %> 
          <br>
          <%= f.submit "Add friends", class: 'btn btn-primary' %>
        <% end %>
      <% end %>
    </div>
  </div>

 
  
</div>